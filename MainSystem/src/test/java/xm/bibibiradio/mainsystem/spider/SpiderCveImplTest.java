package xm.bibibiradio.mainsystem.spider;

import static org.junit.Assert.*;

import java.util.ArrayList;
import java.util.List;

import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;
import org.junit.Test;

import xm.bibibiradio.mainsystem.starter.Env;

import com.bibibiradio.httpsender.HttpSender;
import com.bibibiradio.httpsender.HttpSenderImplV1;

public class SpiderCveImplTest {

	//@Test
	public void test() {
		String content = "<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\"><html xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:wb=“http://open.weibo.com/wb><!-- InstanceBegin template=\"templates/base.dwt.php\" codeOutsideHTMLIsLocked=\"true\" --><head><title>CVE搜索结果  - SCAP中文社区</title><meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\" /><meta name=\"description\" content=\"根据条件 cvss,关键字  列出的CVE搜索结果。(第 2 页)\" /><meta name=\"keywords\" content=\"CVE检索,CVE列表\" /><link rel=\"shortcut icon\" href=\"/favicon.ico\" ><link href=\"static/styles/style.css\" rel=\"stylesheet\" type=\"text/css\" /><link href=\"static/styles/ui/jquery.ui.all.css\" rel=\"stylesheet\" type=\"text/css\" /><script type=\"text/javascript\" src=\"static/components/jquery-1.9.0.min.js\"></script><script type=\"text/javascript\" src=\"static/components/ui/jquery.ui.core.js\"></script><script type=\"text/javascript\" src=\"static/components/ui/jquery.ui.widget.js\"></script><script type=\"text/javascript\" src=\"static/components/ui/jquery.ui.position.js\"></script><script type=\"text/javascript\" src=\"static/components/ui/jquery.ui.tooltip.js\"></script><script type=\"text/javascript\" src=\"static/scripts/common.js\"></script><script src=\"http://tjs.sjs.sinajs.cn/open/api/js/wb.js\" type=\"text/javascript\" charset=\"utf-8\"></script><script>$(function() {		$( document ).tooltip();	});</script><!-- InstanceBeginEditable name=\"head\" --><!-- InstanceEndEditable --></head><body><div class=\"main\">  <div class=\"header\">    <div class=\"header_resize\">    <div class=\"menu_nav\">      <ul>      	<li><a href=\"http://www.scap.org.cn/index.html\" title=\"网站首页\">HOME</a></li>        <li><a href=\"http://cve.scap.org.cn/index.html\" title=\"CVE:通用漏洞与批露\">CVE</a></li>        <li><a href=\"http://oval.scap.org.cn/index.html\" title=\"OVAL:开放漏洞与评估语言\">OVAL</a></li>        <li><a href=\"http://www.scap.org.cn/cce_overview.html\" title=\"CCE:通用配置枚举（测试版）\">CCE</a></li>        <li><a href=\"http://www.scap.org.cn/cwe_overview.html\" title=\"CWE:通用弱点枚举（测试版）\">CWE</a></li>		<li><a href=\"http://android.scap.org.cn/index.html\" title=\"AVD:Android漏洞库（测试版）\">AVD</a></li>        <li><a href=\"http://www.scap.org.cn/about.html\" title=\"关于本站以及访客留言\">ABOUT</a></li>        </ul>      <div class=\"search\">      	<!--        <form id=\"form\" name=\"form\" method=\"post\" action=\"#\">          <span>          <input name=\"q\" type=\"text\" class=\"keywords\" id=\"textfield\" maxlength=\"50\" value=\"使用Google搜索(暂未开放)\" />          </span>          <input name=\"b\" type=\"image\" src=\"static/images/search.gif\" class=\"button\" />                  </form>        --><script>  (function() {    var cx = '010346904645859873614:nwzl-qptkkq';    var gcse = document.createElement('script');    gcse.type = 'text/javascript';    gcse.async = true;    gcse.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') +        '//www.google.com/cse/cse.js?cx=' + cx;    var s = document.getElementsByTagName('script')[0];    s.parentNode.insertBefore(gcse, s);  })();</script><gcse:searchbox-only></gcse:searchbox-only>      </div>      <!--/search -->      </div>      <div class=\"clr\"></div>      <div class=\"logo\">        <h1><a><span><!-- InstanceBeginEditable name=\"ShortName\" -->CVE<!-- InstanceEndEditable --></span>&nbsp;&nbsp;<!-- InstanceBeginEditable name=\"ChineseName\" -->通用漏洞与披露<!-- InstanceEndEditable --></a><small><!-- InstanceBeginEditable name=\"LongName\" -->Common Vulnerabilities and Exposures<!-- InstanceEndEditable -->                </small>        </h1>      </div>      <div class=\"clr\"> </div>    </div>  </div>  <div class=\"clr\"></div>  <div class=\"content\">    <table class=\"content_resize\">      <tr><td valign=\"top\" class=\"mainbar\">		<!-- InstanceBeginEditable name=\"Content\" -->		<div class=\"entry\"><h1>CVSS评分在区间 [0,10] 的搜索结果 (77497)</h1>    <h2><span><a href=\"http://cve.scap.org.cn/CVE-2015-5381.html\">CVE-2015-5381</a></span><span style=\"padding-left:20px\">(发布:2017-05-23 00:29:00)</span><span style=\"padding-left:20px\"><span title=\"NVD数据已链接\" class=\"db_icon_nvd\">N</span><span title=\"MITRE数据已链接\" class=\"db_icon_mitre\">M</span><span title=\"SecurityFocus数据已链接\" class=\"db_icon_securityfocus\">S</span></span><span class=\"cvss_right\"><table border=\"0\" width=\"80px\" height=\"28px\" cellpadding=\"0\" cellspacing=\"0\" class=\"cvss_div\"><tr><td align=\"center\" class = \"cvss_header\">CVSS</td><td align=\"center\" class = \"cvss_medium\"><span class=\"tip_plain\" title=\"中等(MEDIUM)\">4.3</span></td></tr></table></span></h2>    <h3><span class=\"tip_text\" title=\"注：英文原文来自于NVD/Mitre/Red hat等相关网站\">[原文]</span>Cross-site scripting (XSS) vulnerability in program/include/rcmail.php in Roundcube Webmail 1.1.x before 1.1.2 allows remote attackers to inject arbitrary web script or HTML via the _mbox parameter to the default URI.</h3>    <h2><span><a href=\"http://cve.scap.org.cn/CVE-2015-5382.html\">CVE-2015-5382</a></span><span style=\"padding-left:20px\">(发布:2017-05-23 00:29:00)</span><span style=\"padding-left:20px\"><span title=\"NVD数据已链接\" class=\"db_icon_nvd\">N</span><span title=\"MITRE数据已链接\" class=\"db_icon_mitre\">M</span><span title=\"SecurityFocus数据已链接\" class=\"db_icon_securityfocus\">S</span></span><span class=\"cvss_right\"><table border=\"0\" width=\"80px\" height=\"28px\" cellpadding=\"0\" cellspacing=\"0\" class=\"cvss_div\"><tr><td align=\"center\" class = \"cvss_header\">CVSS</td><td align=\"center\" class = \"cvss_medium\"><span class=\"tip_plain\" title=\"中等(MEDIUM)\">4.0</span></td></tr></table></span></h2>    <h3><span class=\"tip_text\" title=\"注：英文原文来自于NVD/Mitre/Red hat等相关网站\">[原文]</span>program/steps/addressbook/photo.inc in Roundcube Webmail before 1.0.6 and 1.1.x before 1.1.2 allows remote authenticated users to read arbitrary files via the _alt parameter when uploading a vCard.</h3>    <h2><span><a href=\"http://cve.scap.org.cn/CVE-2015-5383.html\">CVE-2015-5383</a></span><span style=\"padding-left:20px\">(发布:2017-05-23 00:29:00)</span><span style=\"padding-left:20px\"><span title=\"NVD数据已链接\" class=\"db_icon_nvd\">N</span><span title=\"MITRE数据已链接\" class=\"db_icon_mitre\">M</span></span><span class=\"cvss_right\"><table border=\"0\" width=\"80px\" height=\"28px\" cellpadding=\"0\" cellspacing=\"0\" class=\"cvss_div\"><tr><td align=\"center\" class = \"cvss_header\">CVSS</td><td align=\"center\" class = \"cvss_medium\"><span class=\"tip_plain\" title=\"中等(MEDIUM)\">5.0</span></td></tr></table></span></h2>    <h3><span class=\"tip_text\" title=\"注：英文原文来自于NVD/Mitre/Red hat等相关网站\">[原文]</span>Roundcube Webmail 1.1.x before 1.1.2 allows remote attackers to obtain sensitive information by reading files in the (1) config, (2) temp, or (3) logs directory.</h3>    <h2><span><a href=\"http://cve.scap.org.cn/CVE-2015-5468.html\">CVE-2015-5468</a></span><span style=\"padding-left:20px\">(发布:2017-05-23 00:29:00)</span><span style=\"padding-left:20px\"><span title=\"NVD数据已链接\" class=\"db_icon_nvd\">N</span><span title=\"MITRE数据已链接\" class=\"db_icon_mitre\">M</span></span><span class=\"cvss_right\"><table border=\"0\" width=\"80px\" height=\"28px\" cellpadding=\"0\" cellspacing=\"0\" class=\"cvss_div\"><tr><td align=\"center\" class = \"cvss_header\">CVSS</td><td align=\"center\" class = \"cvss_medium\"><span class=\"tip_plain\" title=\"中等(MEDIUM)\">5.0</span></td></tr></table></span></h2>    <h3><span class=\"tip_text\" title=\"注：英文原文来自于NVD/Mitre/Red hat等相关网站\">[原文]</span>Directory traversal vulnerability in the WP e-Commerce Shop Styling plugin before 2.6 for WordPress allows remote attackers to read arbitrary files via a .. (dot dot) in the filename parameter to includes/download.php.</h3>    <h2><span><a href=\"http://cve.scap.org.cn/CVE-2015-5469.html\">CVE-2015-5469</a></span><span style=\"padding-left:20px\">(发布:2017-05-23 00:29:00)</span><span style=\"padding-left:20px\"><span title=\"NVD数据已链接\" class=\"db_icon_nvd\">N</span><span title=\"MITRE数据已链接\" class=\"db_icon_mitre\">M</span></span><span class=\"cvss_right\"><table border=\"0\" width=\"80px\" height=\"28px\" cellpadding=\"0\" cellspacing=\"0\" class=\"cvss_div\"><tr><td align=\"center\" class = \"cvss_header\">CVSS</td><td align=\"center\" class = \"cvss_medium\"><span class=\"tip_plain\" title=\"中等(MEDIUM)\">5.0</span></td></tr></table></span></h2>    <h3><span class=\"tip_text\" title=\"注：英文原文来自于NVD/Mitre/Red hat等相关网站\">[原文]</span>Absolute path traversal vulnerability in the MDC YouTube Downloader plugin 2.1.0 for WordPress allows remote attackers to read arbitrary files via a full pathname in the file parameter to includes/download.php.</h3>    <h2><span><a href=\"http://cve.scap.org.cn/CVE-2016-4854.html\">CVE-2016-4854</a></span><span style=\"padding-left:20px\">(发布:2017-05-22 12:29:00)</span><span style=\"padding-left:20px\"><span title=\"NVD数据已链接\" class=\"db_icon_nvd\">N</span><span title=\"MITRE数据已链接\" class=\"db_icon_mitre\">M</span><span title=\"SecurityFocus数据已链接\" class=\"db_icon_securityfocus\">S</span></span><span class=\"cvss_right\"><table border=\"0\" width=\"80px\" height=\"28px\" cellpadding=\"0\" cellspacing=\"0\" class=\"cvss_div\"><tr><td align=\"center\" class = \"cvss_header\">CVSS</td><td align=\"center\" class = \"cvss_medium\"><span class=\"tip_plain\" title=\"中等(MEDIUM)\">6.8</span></td></tr></table></span></h2>    <h3><span class=\"tip_text\" title=\"注：英文原文来自于NVD/Mitre/Red hat等相关网站\">[原文]</span>Cross-site request forgery (CSRF) vulnerability in L-04D firmware version V10a and V10b allows remote attackers to hijack the authentication of administrators to perform arbitrary operations via unspecified vectors.</h3>        	<div class=\"article\" style=\"padding:20px 0px 0px 0px; background:none; border:0;\"><span class=\"butons\"><a href='cve_list.php?action=cvss&ceil=10&p=1'>首页</a><a href='cve_list.php?action=cvss&ceil=10&p=1'>上一页</a><a href='cve_list.php?action=cvss&ceil=10&p=1'>1</a><a href=\"#\" class=\"active\">2</a><a href='cve_list.php?action=cvss&ceil=10&p=3'>3</a><a href='cve_list.php?action=cvss&ceil=10&p=4'>4</a><a href='cve_list.php?action=cvss&ceil=10&p=5'>5</a><a href='cve_list.php?action=cvss&ceil=10&p=6'>6</a><a href='cve_list.php?action=cvss&ceil=10&p=7'>7</a><a href='cve_list.php?action=cvss&ceil=10&p=8'>8</a><a href='cve_list.php?action=cvss&ceil=10&p=3'>下一页</a><a href='cve_list.php?action=cvss&ceil=10&p=12917'>尾页</a></span> <span class=\"desc\">第2页 / 共12917页</span></div></div>		<!-- InstanceEndEditable -->      </td>      <td valign=\"top\" class=\"sidebar\">	  <!-- InstanceBeginEditable name=\"Menus\" -->            <div class=\"gadget\">          <h2>CVE数据库</h2>          <div class=\"clr\"></div>          <ul class=\"sb_menu\">              <li><a href=\"cve_search.html\">CVE高级检索</a></li>              <li><a href=\"cve_list.php?action=recent\">最新CVE列表</a></li>          </ul>        </div>      <div class=\"gadget\">        <input name=\"log\" type=\"hidden\" value=\"1\" />           <h2>检索CVE</h2>			<input name=\"cveid\" type=\"text\" class=\"searchbox\" id=\"cveid\" placeholder=\"输入关键字或CVE标识\" size=\"23\" title=\"请按照CVE-2013-0707、20130707的格式输入查看CVE，或者输入关键字检索。\"/>			<br />            			<input type=\"button\" name=\"submit2\" id=\"submit2\" src=\"static/images/submit.gif\" class=\"send\" value=\"查看/检索CVE\" onclick=\"viewcve()\"/><br />                    </form>		</div>	  <div class=\"gadget\">		            <h2>关于CVE</h2>          <div class=\"clr\"></div>          <ul class=\"sb_menu\">              <li><a href=\"article_cve_about-cve.html\">CVE标准概述</a></li>              <li><a href=\"article_cve_architecture-cve.html\">CVE标准架构</a></li>          </ul>        </div>      <div class=\"gadget\">          <h2>CVE资源</h2>          <div class=\"clr\"></div>          <ul class=\"sb_menu\">              <li><a href=\"cve_articles.html\">CVE文章列表</a></li>              <li><a href=\"article_cve_resources-cve.html\">CVE资源列表</a></li>          </ul>        </div>        <script>$(\"#cveid\").keyup(function(){        if(event.keyCode == 13){            viewcve();        }    });</script>        	  <!-- InstanceEndEditable -->        <div class=\"gadget\">          <h2>Wise Words</h2>          <div class=\"clr\"></div>          <p class=\"wisewords\"><img src=\"static/images/test_1.gif\" alt=\"image\" width=\"20\" height=\"19\" /> We must accept finite disappointment, but we must never lose infinite hope.<img src=\"static/images/test_2.gif\" alt=\"image\" width=\"20\" height=\"19\" /></p>          <p class=\"wisewords_author\">--&nbspMattin Luther King</p>        </div>      </td>      <div class=\"clr\"></div>    </tr>  </table>  <div style=\"height:5px\"></div>  <table border=\"0\" cellspacing=\"0\" cellpadding=\"0\" class=\"fbg_resize\">  <tr>    <td width=\"320\" valign=\"top\"><h2><span>关于SCAP</span>中文社区</h2>        SCAP中文社区是国内第一个以SCAP为主题的中文开放社区。了解更多信息，请查阅[<a href=\"about.html\">关于本站]</a>。</td>    <td width=\"320\" valign=\"top\"><h2><span>版权声明</span></h2>        CVE/CWE/OVAL均为MITRE公司的注册商标，它们的官方数据源均保存在<a href=\"http://measurablesecurity.mitre.org\" target=\"_blank\">MITRE公司的相关网站</a>。</td>    <td width=\"320\" valign=\"top\"><wb:follow-button uid=\"1418901063\" type=\"red_4\" width=\"300\" height=\"64\" ></wb:follow-button></td>  </tr> </table><div style=\"height:5px\"></div><div style=\"width:auto;background-color:#000\"> <table border=\"0\" cellspacing=\"0\" cellpadding=\"0\" class=\"footer\">        <tr>          <td width=\"250\" nowrap=\"nowrap\"><span style=\"color:#FFF\">© Copyright 2014 <a href=\"http://weibo.com/u/1418901063\" target=\"_blank\">@evan-css</a>. CCERT.</span><p>          <span style=\"color:#FFF\">京ICP备14000297号-2</span></p></td>          <td width=\"800\" valign=\"top\"><ul class=\"ul_friends\"><li class=\"li_friends\"><a href=\"http://www.youxia.org/\" target=\"_blank\">游侠安全网</a></li><li class=\"li_friends\"><a href=\"http://www.freebuf.com/\" target=\"_blank\">FreebuF.com</a></li><li class=\"li_friends\"><a href=\"http://www.seckungfu.com/\" target=\"_blank\">安全功夫</a></li><li class=\"li_friends\"><a href=\"http://bobylive.com/\" target=\"_blank\">Firefly风物</a></li><li class=\"li_friends\"><a href=\"http://sebug.net/\" target=\"_blank\">Sebug漏洞库</a></li><li class=\"li_friends\"><a href=\"http://www.cn-hack.net/\" target=\"_blank\">黑客榜中榜</a></li><li class=\"li_friends\"><a href=\"http://www.nxadmin.com/\" target=\"_blank\">阿德马web安全</a></li><li class=\"li_friends\"><a href=\"http://www.duusu.com/\" target=\"_blank\">独速</a></li><li class=\"li_friends\"><a href=\"http://web2hack.org/\" target=\"_blank\">web2hack</a></li><li class=\"li_friends\"><a href=\"http://www.dadan.org/\" target=\"_blank\">大胆's BLOG</a></li><li class=\"li_friends\"><a href=\"http://www.cnnetsec.com/\" target=\"_blank\">InfoSecLab</a></li><li class=\"li_friends\"><a href=\"http://www.91ri.org\" target=\"_blank\">安全攻防实验室</a></li><li class=\"li_friends\"><a href=\"http://www.pediy.com/\" target=\"_blank\">看雪学院</a></li><li class=\"li_friends\"><a href=\"http://sec-wiki.com\" target=\"_blank\">SecWiki</a></li><li class=\"li_friends\"><a href=\"http://www.cnhack.com.cn/\" target=\"_blank\">黑客中文网</a></li><li class=\"li_friends\"><a href=\"http://www.idaofeng.com/\" target=\"_blank\">刀锋安全</a></li><li class=\"li_friends\"><a href=\"http://sec007.cc/\" target=\"_blank\">安全凌凌柒</a></li><li class=\"li_friends\"><a href=\"http://www.rptcinfo.com\" target=\"_blank\">瑞鹏天乘科技</a></li><li class=\"li_friends\"><a href=\"http://www.bugsec.org/\" target=\"_blank\">BugSec</a></li><li class=\"li_friends\"><a href=\"http://www.1937cn.com/forum.php\" target=\"_blank\">中国网军公盟</a></li><li class=\"li_friends\"><a href=\"http://www.ourlove520.com\" target=\"_blank\">IT学习网</a></li><li class=\"li_friends\"><a href=\"http://edu.gooann.com/\" target=\"_blank\">谷安网校</a></li><li class=\"li_friends\"><a href=\"http://www.metasploit.cn/\" target=\"_blank\">渗透测试</a></li><li class=\"li_friends\"><a href=\"http://www.hdhacker.com/\" target=\"_blank\">黑盾科技论坛</a></li><li class=\"li_friends\"><a href=\"#\" title=\"请在微博私信或发邮件至langkew@gmail.com申请\">您的位置...</a></li></ul></td>        </tr>      </table></div><div style=\"display:none\"><script type=\"text/javascript\">var _bdhmProtocol = ((\"https:\" == document.location.protocol) ? \" https://\" : \" http://\");document.write(unescape(\"%3Cscript src='\" + _bdhmProtocol + \"hm.baidu.com/h.js%3Fca227db14814d01f2e44f01433e48552' type='text/javascript'%3E%3C/script%3E\"));</script></div><!-- Piwik --><script type=\"text/javascript\">   var _paq = _paq || [];  _paq.push(['trackPageView']);  _paq.push(['enableLinkTracking']);  (function() {    var u=((\"https:\" == document.location.protocol) ? \"https\" : \"http\") + \"://www.scap.org.cn/piwik//\";    _paq.push(['setTrackerUrl', u+'piwik.php']);    _paq.push(['setSiteId', 1]);    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0]; g.type='text/javascript';    g.defer=true; g.async=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);  })();</script><noscript><p><img src=\"http://www.scap.org.cn/piwik/piwik.php?idsite=1\" style=\"border:0\" alt=\"\" /></p></noscript><!-- End Piwik Code --> </body><!-- InstanceEnd --></html>";
		Document doc = Jsoup.parse(content);
		
		List<CveData> cveDatas = new ArrayList<CveData>();
		
		Elements eles = doc.select("div.entry h2");
		for(Element ele : eles){
			Element titleEle = ele.select("a").get(0);
			String cveUrl = titleEle.attr("href");
			String cveTitle = titleEle.text();
			
			Element timeEle = ele.select("span[style=padding-left:20px]").get(0);
			String date = timeEle.text();
			date = date.substring("(发布:".length(), date.length()-1);
			
			Element scoreEle = ele.select("span.tip_plain").get(0);
			String cveLevel = scoreEle.attr("title");
			String cveScore = scoreEle.text();
			//System.out.println(cveTitle+":"+cveUrl+":"+cveScore+":"+cveLevel);
			
			CveData cveData = new CveData();
			cveData.setTitle(cveTitle);
			cveData.setUrl(cveUrl);
			cveData.setScore(cveScore);
			cveData.setDate(date);
			
			cveDatas.add(cveData);
			//System.out.println(ele.toString()+"aaaaa\n\naaaaa");
		}
		
		eles = doc.select("div.entry h3");
		int i = 0;
		for(Element ele : eles){
			CveData cveData = cveDatas.get(i);
			cveData.setContent(ele.text());
			i++;
			System.out.println(cveData.getTitle()+":"+cveData.getDate()+":"+cveData.getUrl()+":"+cveData.getScore()+":"+cveData.getContent());
			//System.out.println(ele.toString()+"aaaaa\n\naaaaa");
		}
		
		
	}
	
	//@Test
	public void test2() throws Exception{
		HttpSender httpSenderStart;
		
		httpSenderStart = new HttpSenderImplV1();
		httpSenderStart.setCodec(true);
		httpSenderStart.setRetryTime(3);
		httpSenderStart.setSendFreq(1000);
		httpSenderStart.setTimeout(30000);
		httpSenderStart.setSoTimeout(30000);

		httpSenderStart.start();
		
		List<CveData> cveDatas = new SpiderCveImpl().getCves(1, httpSenderStart);
		
		for(CveData cveData : cveDatas){
			System.out.println(cveData.getTitle()+":"+cveData.getDate()+":"+cveData.getUrl()+":"+cveData.getScore()+":"+cveData.getContent());
		}
	}
	
	@Test
	public void test3() throws Exception{
		//long a = (long)(Double.valueOf("3.1")*10);
		
		//System.out.println("CVE-1999-0095".hashCode());
		
		Env.setEnvFlag(1);
		SpiderCveImpl cves = new SpiderCveImpl();
		cves.init("");
		cves.startAfter("");
		//cves.startForward("");
	}

}
